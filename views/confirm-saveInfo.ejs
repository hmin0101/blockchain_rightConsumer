<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Login</title>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>

    <!--  Bootstrap 4.3.1  -->
    <link rel="stylesheet" href="/stylesheets/bootstrap-4.3.1.min.css">
    <!--  Custom CSS  -->
    <link rel='stylesheet' href='/stylesheets/style.css' />

    <style>
      body {
        user-select: none;
      }

      .form-item {
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3), 0 2px 3px rgba(0, 0, 0, 0.2);
      }
      .login-logo {
        font-size: 83px;
        font-weight: 300;
        letter-spacing: -4px;
      }
    </style>
  </head>
  <body>
    <section>
      <div class="container">
        <div class="row align-items-center justify-content-center flex-wrap" style="min-height: 95vh;">
          <div class="row col-lg-12 align-items-center justify-content-center" style="height: 100%">
            <div class="col-lg-4 p-5 form-item" id="form-search">
              <div class="text-center">
                <h3 class="mb-2 main-color-3-f">약관 동의 조회</h3>
                <p class="mb-4 main-color-3-f">Right Consumer 의 요청으로 동의한 약관 내역을 저장한 Block 정보를 조회합니다.</p>
              </div>
              <div class="form-group mb-0">
                <button class="btn btn-block btn-basic" id="btn-search">Search</button>
              </div>
            </div>
            <div class="col-lg-6 p-5 form-item hidden" id="form-decrypt">
              <div class="text-center">
                <h3 class="title mb-2 main-color-3-f">조회한 Block 정보</h3>
                <p class="sub-title mb-4 main-color-3-f">현재 약관 동의 내역을 저장한 Block에 대한 정보가 암호화 되어있습니다. 복호화를 위해서는 <strong style="color: #E8A62C;">Priate Key</strong>가 필요합니다.</p>
              </div>
              <div class="form-group">
                <div id="form-result" style="overflow-wrap: break-word"></div>
              </div>
              <div class="form-group mb-0">
                <button class="btn btn- btn-basic" id="btn-cancel">Cancel</button>
                <button class="btn btn- btn-basic" id="btn-decrypt">Decrypt</button>
                <input class="hidden input-import-key" id="input-file" type="file" />
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!--  JQuery  -->
    <script src="/javascripts/jquery-1.12.4.min.js"></script>
    <!--  Bootstrap 4.3.1 JS  -->
    <script src="/javascripts/bootstrap-4.3.1.min.js"></script>
    <!--  Subtle Crypto  -->
    <script src="/javascripts/subtleCrypto.js"></script>
    <script>
      $(document).ready(function() {
        let encrypted = null;

        // Search button click event
        $('#btn-search').on('click', function() {
          $.ajax({
            type: "POST",
            url: "/search/agreement",
            success: function(res) {
              if (res) {
                encrypted = res.info;
                $('#form-search').addClass("hidden");
                $('#form-result').text(res.info);
                $('#form-decrypt').removeClass("hidden");
              } else {
                alert(res.message);
              }
            }
          });
        });

        // Decrypt Button Event
        $('#btn-decrypt').on('click', function() {
          $('#input-file').click();
        });

        // Decrypt
        $('#input-file').on('change', async function() {
          if (encrypted !== null) {
            const reader = new FileReader();
            reader.readAsText(this.files[0]);
            reader.onload = async function() {
              // $.ajax({
              //   type: "POST",
              //   url: "/test/key",
              //   data: "data="+encodeURIComponent(JSON.stringify({keyData: reader.result, data: encrypted})),
              // });

              await importPrivateKey(reader.result);
              const result = await decryptData(encrypted);
              if (result.result) {

              } else {
                  alert(result.message);
              }
            }
          } else {
            alert("복호화할 데이터가 없습니다.");
          }
        });

        // Cancel Button Event
        $('#btn-cancel').on('click', function() {
          encrypted = null;
          $('#form-search').removeClass("hidden");
          $('#form-decrypt').addClass("hidden");
        });

        // Logout
        $('#btn-logout').on('click', function() {
          $.ajax({
            type: 'POST',
            url: "/logout",
            success: function(res) {
              location.href = "/login";
            }
          });
        });

      });
    </script>
  </body>
</html>
